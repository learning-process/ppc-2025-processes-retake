# Решение систем линейных уравнений методом сопряженных градиентов

- Студент: Савва Дария Александровна, 3823Б1ФИ1
- Технологии: SEQ | MPI
- Вариант: 6

## 1. Введение

Целью данной лабораторной работы является реализация и исследование метода
сопряжённых градиентов для решения систем линейных уравнений.  
В работе рассматриваются две реализации алгоритма: последовательная (SEQ) и параллельная (MPI),
а также проверяется их корректность и измеряется производительность.  
Особое внимание уделяется анализу ускорения параллельной версии на многопроцессорной
системе и оценке эффективности распределения вычислений между процессами.

## 2. Постановка задачи

Пусть дана система линейных уравнений порядка n, имеющая вид:
 A · x = b, где:

- $A$ — квадратная симметричная положительно определённая матрица размера n,
- $x$ — вектор неизвестных длины n,
- $b$ — вектор свободных членов длины n.

Необходимо найти приближённое решение системы линейных уравнений $x$ заданной точности `eps`.

**Ограничения и требования:**

- Матрица $A$ должна являться симметричной положительно определённой, чтобы гарантировать сходимость метода.
- Максимальное количество итераций и точность решения фиксируются в алгоритме.

## 3. Последовательная реализация

Основана на классическом методе сопряжённых градиентов.
Алгоритм начинается с начального приближения $x^{(0)}\$ и уточняет решение с каждой последующей итерацией.

1. Инициализация:
   x₀ = 0 - начальный вектор решения
   r₀ = b - A·x₀  - начальная невязка
   p₀ = r₀ - начальное направление
   k = 0 - номер итерации

2. На каждой итерации $k = 1, 2, \dots,$ max_iter вычисляются:
   2.1. αₖ = (rₖᵀ·rₖ) / (pₖᵀ·A·pₖ)
   2.2. xₖ₊₁ = xₖ + αₖ·pₖ
   2.3. rₖ₊₁ = rₖ - αₖ·A·pₖ
   2.4. Проверка условия остановки: ∥rₖ₊₁∥<ε. Если выполняется - переход к шагу 3.
   2.4. βₖ = (rₖ₊₁ᵀ·rₖ₊₁) / (rₖᵀ·rₖ)
   2.5. pₖ₊₁ = rₖ₊₁ + βₖ·pₖ

3. Возврат вектора xₖ₊₁ как приближенного решения системы.

Алгоритм завершается при достижении заданной точности или максимального числа итераций.

## 4. Описание схемы параллельного алгоритма

Для ускорения решения системы методом сопряжённых градиентов используется
**параллельная реализация с MPI**, основанная на распределении строк матрицы между процессами.  

**Схема работы алгоритма:**

**1 этап. Инициализация и разделение данных**:  

   1) Нулевой процесс имеет доступ к входным данным задачи, и рассылает всем процессам
размерность матрицы коэффициентов $n$, используя Bcast.
   2) Каждый процесс создаёт вектор $r$ размера $n$, участвующий в последующих вычилениях.
Нулевой процесс присваивает ему значение вектора $b$ и рассылает полученный вектор $r$ другим процессам, используя Bcast.
   3) Матрица $A$ делится по строкам между процессами следующим образом:
если количество строк $n$ не кратно числу процессов, первые процессы получают на одну строку больше,
чтобы сбалансировать нагрузку. Иначе - строки делятся поровну между процессами.
      Нулевой процесс рассылает каждому процессу соответсвующие ему строки матрицы $A$.
   4) На каждом процессе создаётся вектор $x$ результирующего решения, изначально инициализированный нулями.
Этот вектор одинаковый на соответсвующих итерациях каждого процесса,
в том числе по окончании выполнения алгоритма, расчитывается локально и не участвует в обмене данными.
   5) Каждый процесс также имеет свой вектор $p$, одинаковый для всех процессов на соответсвующих итерациях
и расчитываемый локально. Изначально ему присваивается значение вектора $r$.

**2 этап. Локальные вычисления**:
  
Каждый процесс вызывает функцию $RunCGIterations$, выполняющую основной цикл алгоритма.
Внутри этой функции создаётся вектор $global_Ap$ предназначенный для хранения вектора результата
умножения всей матрицы $A$ на $p$,
определяются параметры максимальное число итераций $max_iter$ и минимальная погрешность решения $eps$.
Далее цикл $for$, имеющий $max_iter$ шагов. На итерации каждый процесс считает свою часть умножения матрицы
$A$ на вектор $p$. Записывает результат в $global_Ap$.
Далее со всех процессов собирается итоговый $global_Ap$, его получает каждый процесс.
Для этого используется MPI-функция $MPI_Allgatherv$, в неё в качестве параметров прередаются
в частности массивы $displs$ и $counts$,
последовательно хранящие смещения и количества строк для каждого процесса.
После, используя полученный вектор, локально вычисляются скаляры αₖ, βₖ и
вектора rₖ₊₁, pₖ₊₁, $x$ согласно приведённым выше формулам.

**3 этап. Точка выхода**:  
В начале каждой итерации вычисляется невязка предыдущей итерации, и в случае если невязка меньше
погрешности $eps$, происходит выход из цикла на каждом процессе -
решение достаточной точности найдено.

**4 этап. Завершение вычислений**:  
Происходит выход из функции $RunCGIterations$. Вектор $x$ содержит решение системы и доступен на всех процессах.

**Особенности параллельной реализации:**

- Декомпозиция по строкам матрицы коэффициентов обеспечивает равномерное
распределение нагрузки между процессами.  
- Основная эффективность параллельного алгоритма достигается за счёт распределения между процессами
умножения матрицы системы на вектор.
Вычисления с векторами и числами осуществяются локально, так как распределение вычислений и обмен
данными здесь привёл бы к ненужным накладным расходам.

## 5. Проведение экспериментов

### 5.1 Условия экспериментов

- Размер системы линейных уравнений: $n = 3000$  
- Среда выполнения: Windows 10, процессор 4 ядра, MPI (OpenMPI 4.1)  
- Число процессов MPI: 1, 2, 4  
- Последовательная версия (SEQ) запускается на одном процессе  
- Измерение времени: встроенные средства тестового фреймворка GoogleTest с фиксированной точностью  

### 5.2 Результаты времени выполнения и ускорения

| Режим выполнения | Число процессов | Время (сек) | Ускорение | Эффективность, % |
|:-----------------|----------------:|------------:|----------:|-----------------:|
| SEQ              | 1               | 0.0469286000| 1.00      | –                |
| MPI              | 2               | 0.0275360926| 1.70      | 0.85             |
| MPI              | 4               | 0.0155672884| 3.01      | 0.75             |
| MPI              | 8               | 0.0537610600| 0.87      | 0.11             |

**Выводы по производительности:**

- Наиболее эффективно себя показало использование 4 процессов, при котором получено ускорение в 3 раза.
При этом количестве процессов достигается наилучший компромисс между эффективностью параллельных вычислений
и накладными расходами на коммуникацию между процессами.
- Эффективность уменьшается при дальнейшем увеличении числа процессов после 4 процессов
из-за накладных расходов на коммуникацию.

## Подтверждение корректности

Функциональные тесты проверяли алгоритмы на следующих системах:

1. Пустая система  
2. Система из одного уравнения  
3. 2×2, 3×3, 4×4 системы с отрицательными и дробными элементами  

**Результаты:**

- Решения, которые вернули алгоритмы, сравнивались с вектором, являющимся точным
решением соответсвующей системы линейных уравнений.  
- Последовательная и параллельная версии дают максимальную погрешность с правильным
решением не более 0.0001 для всех тестов.  
При этом все системы имеют положительно определённую симметричную матрицу коэффициентов.

Таким образом, обе реализации метода сопряжённых градиентов работают корректно.

---

## 6. Выводы и заключение

1. Реализованы **последовательная (SEQ)** и **параллельная (MPI)** версии метода сопряжённых
градиентов для решения систем линейных уравнений.  
2. Проверена корректность обеих реализаций с помощью функциональных тестов на системах разного
 размера и содержания; результаты с достаточной точностью совпадают с эталонными решениями.  
3. Проведены эксперименты на производительность на вычислительной машине с 4 ядрами,
использовалась система линейных уравнений размера $n = 3000$:  
   - Параллельная версия MPI показала ускорение по сравнению с последовательной реализацией.  
   - Эффективность использования процессов уменьшается с ростом числа процессов,
начиная от 4 процессов, из-за накладных расходов на обмен данными.  
4. Метод сопряжённых градиентов эффективно решает большие системы при правильном выборе числа
процессов и обеспечивает точное решение с высокой сходимостью при положительно определённой
симметричной матрицы коэффициентов.  

**Заключение:**  
В ходе лабораторной работы был изучен итерационный метод сопряжённых градиентов, реализован в
последовательной и параллельной версиях, также была проверена корректность и измерена производительность
 реализаций алгоритма. MPI-реализация показала преимущество при решении
больших систем, подтверждая эффективность распределения вычислений между процессами

## Список литературы

1. Документация по OpenMPI — <https://www.open-mpi.org/doc/>
2. cppreference.com - <https://en.cppreference.com/>
3. Лекции по параллельному программированию ННГУ

---
